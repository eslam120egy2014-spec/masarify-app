<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Premium SaaS Expense Tracking Solution">
    <title>ExpensePro SaaS Elite</title>

    <link rel="manifest" href='data:application/manifest+json,{"name":"ExpensePro SaaS Elite","short_name":"ExpensePro","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#3b82f6","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2454/2454282.png","sizes":"512x512","type":"image/png"}]}'>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        surface: { dark: '#0f172a', light: '#f8fafc' },
                        brand: { primary: '#3b82f6', secondary: '#8b5cf6', accent: '#f59e0b' }
                    },
                    fontFamily: { sans: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.1); }
        .light { --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(0, 0, 0, 0.05); }

        body { 
            background: #0f172a; 
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        body.light { 
            background: #f1f5f9; 
            color: #0f172a;
        }
        body.dark {
            color: #ffffff;
        }

        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--glass-border);
        }

        .premium-gradient { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .tap-scale { transition: transform 0.1s ease; }
        .tap-scale:active { transform: scale(0.96); }

        .swipe-container { overflow: hidden; position: relative; }
        
        canvas { filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); }

        .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #3b82f6; transition: all 0.2s; }
        .pin-dot.active { background: #3b82f6; transform: scale(1.2); }

        .wallet-card-cash { background: linear-gradient(145deg, #10b98130, #05966930); border: 1px solid #10b98150; }
        .wallet-card-visa { background: linear-gradient(145deg, #3b82f630, #2563eb30); border: 1px solid #3b82f650; }
        .wallet-card-vodafone { background: linear-gradient(145deg, #f59e0b30, #d9770630); border: 1px solid #f59e0b50; }
        .dark .wallet-card-cash { background: linear-gradient(145deg, #10b98120, #05966920); border-color: #10b98180; }
        .dark .wallet-card-visa { background: linear-gradient(145deg, #3b82f620, #2563eb20); border-color: #3b82f680; }
        .dark .wallet-card-vodafone { background: linear-gradient(145deg, #f59e0b20, #d9770620); border-color: #f59e0b80; }
        
        .wallet-label, .wallet-balance { color: #fff; }
        .light .wallet-label, .light .wallet-balance { color: #1e293b; }
    </style>
</head>
<body class="dark font-sans overflow-x-hidden">

    <nav class="fixed top-0 inset-x-0 z-50 glass border-b px-6 py-4 flex justify-between items-center transition-all">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 premium-gradient rounded-xl flex items-center justify-center shadow-lg tap-scale">
                <i class="fa-solid fa-fingerprint text-white text-lg"></i>
            </div>
            <div>
                <h2 class="text-sm font-black dark:text-white light:text-slate-900 leading-none">Ø¥ÙŠÙ„ÙŠØª Ø³Ù€Ø§Ø³</h2>
                <span id="header-status" class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest mt-1 flex items-center gap-1">
                    <span class="w-1 h-1 bg-emerald-500 rounded-full animate-ping"></span> Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
                </span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="UI.showModal('export-modal')" class="w-9 h-9 rounded-lg glass flex items-center justify-center text-slate-400" title="ØªØµØ¯ÙŠØ±">
                <i class="fa-solid fa-file-export"></i>
            </button>
            <button onclick="UI.toggleAmountVisibility()" class="w-9 h-9 rounded-lg glass flex items-center justify-center text-slate-400">
                <i id="eye-icon" class="fa-solid fa-eye"></i>
            </button>
            <button onclick="UI.toggleTheme()" class="w-9 h-9 rounded-lg glass flex items-center justify-center text-slate-400">
                <i id="theme-icon" class="fa-solid fa-moon"></i>
            </button>
            <button onclick="UI.showModal('settings-modal')" class="w-9 h-9 rounded-lg glass flex items-center justify-center text-slate-400">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </nav>

    <main id="app-content" class="pt-24 pb-32 px-4 max-w-4xl mx-auto space-y-6">

        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="glass p-6 rounded-[2.5rem] relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-brand-primary opacity-5 blur-3xl group-hover:opacity-20 transition-all"></div>
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-black text-brand-primary uppercase tracking-widest mb-1">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
                        <h3 id="personal-budget-label" class="text-3xl font-black dark:text-white light:text-slate-900 tracking-tighter">0.00</h3>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-brand-primary/10 flex items-center justify-center text-brand-primary">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400">
                        <span>Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ Ù…Ù† Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</span>
                        <span id="personal-budget-percent">0%</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-800/50 rounded-full overflow-hidden">
                        <div id="personal-budget-progress" class="h-full premium-gradient transition-all duration-700" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="glass p-6 rounded-[2.5rem] border-brand-secondary/20">
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-xs font-black text-brand-secondary uppercase tracking-widest">ØªØ­Ù„ÙŠÙ„Ø§Øª Ø°ÙƒÙŠØ©</h4>
                    <i class="fa-solid fa-wand-magic-sparkles text-brand-secondary"></i>
                </div>
                <div id="smart-insight-container" class="space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-500 text-xs">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <p id="insight-forecast" class="text-[11px] font-bold text-slate-400">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹...</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-brand-accent/10 flex items-center justify-center text-brand-accent text-xs">
                            <i class="fa-solid fa-fire-flame-curved"></i>
                        </div>
                        <p id="insight-category" class="text-[11px] font-bold text-slate-400">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø§Ø³ØªÙ‡Ù„Ø§ÙƒØ§Ù‹...</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="glass p-5 rounded-3xl md:col-span-2">
                <h4 class="text-xs font-black mb-4 uppercase text-slate-500">Ù…Ù†Ø­Ù†Ù‰ Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h4>
                <canvas id="lineChart" height="120"></canvas>
            </div>
            <div class="glass p-5 rounded-3xl">
                <h4 class="text-xs font-black mb-4 uppercase text-slate-500">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</h4>
                <canvas id="pieChart" height="200"></canvas>
            </div>
        </section>

        <section class="glass p-4 rounded-3xl flex flex-wrap gap-3 items-center">
            <div class="relative flex-1 min-w-[200px]">
                <i class="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                <input type="text" id="search-input" oninput="UI.refreshList()" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." class="w-full h-11 bg-slate-900/40 rounded-xl pr-10 pl-4 text-xs font-bold border border-white/5 focus:border-brand-primary outline-none transition-all">
            </div>
            <select id="filter-type" onchange="UI.refreshList()" class="h-11 px-4 bg-slate-900/40 rounded-xl text-xs font-bold border border-white/5 outline-none">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="work">Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø¹Ù…Ù„</option>
                <option value="personal">Ù…ØµØ±ÙˆÙØ§Øª Ø´Ø®ØµÙŠØ©</option>
            </select>
        </section>

        <section id="entries-list" class="space-y-3">
            </section>

    </main>

    <div class="fixed bottom-0 inset-x-0 h-24 glass border-t flex justify-around items-center px-10 z-[60]">
        <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="flex flex-col items-center gap-1 text-[10px] font-black text-brand-primary">
            <i class="fa-solid fa-house-chimney text-xl"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button onclick="UI.showModal('add-modal')" class="w-16 h-16 premium-gradient rounded-full -mt-12 flex items-center justify-center text-white text-2xl shadow-2xl tap-scale border-[6px] border-[#0f172a] dark:border-[#0f172a] light:border-[#f1f5f9]">
            <i class="fa-solid fa-plus"></i>
        </button>
        <button onclick="WalletAuth.showAuth()" class="flex flex-col items-center gap-1 text-[10px] font-black text-slate-500">
            <i class="fa-solid fa-wallet text-xl"></i>
            <span>Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
        </button>
    </div>

    <div id="add-modal" class="modal-backdrop fixed inset-0 bg-slate-950/80 backdrop-blur-xl z-[200] hidden flex items-end md:items-center justify-center p-4">
        <div class="glass w-full max-w-lg rounded-[2.5rem] p-8 space-y-6 animate-in slide-in-from-bottom-10 duration-300 overflow-y-auto max-h-[90vh] no-scrollbar">
            <div class="flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-black">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <button onclick="UI.closeModal('add-modal')" class="text-slate-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="flex p-1 bg-slate-900/50 rounded-2xl">
                <button onclick="UI.setFormSection('work')" id="form-tab-work" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-brand-primary text-white transition-all">Ø§Ù„Ø¹Ù…Ù„</button>
                <button onclick="UI.setFormSection('personal')" id="form-tab-personal" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase text-slate-500 transition-all">Ø§Ù„Ø´Ø®ØµÙŠ</button>
            </div>

            <form id="main-form" class="space-y-4">
                <input type="hidden" id="entry-id">
                <div class="relative">
                    <input type="number" id="f-amount" step="0.5" required placeholder="0.00" class="w-full h-20 bg-transparent text-center text-5xl font-black outline-none placeholder:text-slate-800 text-brand-primary">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
                        <select id="f-category" class="w-full h-12 bg-slate-900/40 border border-white/5 rounded-xl px-4 text-xs font-bold outline-none"></select>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-slate-500 uppercase px-1">ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select id="f-wallet" class="w-full h-12 bg-slate-900/40 border border-white/5 rounded-xl px-4 text-xs font-bold outline-none">
                            <option value="cash">ÙƒØ§Ø´ (Ù†Ù‚Ø¯ÙŠ)</option>
                            <option value="visa">ÙÙŠØ²Ø§</option>
                            <option value="vodafone">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-1.5">
                    <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" id="f-date" required class="w-full h-12 bg-slate-900/40 border border-white/5 rounded-xl px-4 text-xs font-bold outline-none uppercase">
                </div>

                <div id="custom-category-container" class="space-y-1.5 hidden">
                    <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ø§ÙƒØªØ¨ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                    <input type="text" id="f-custom-category" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù‡Ø¯Ø§ÙŠØ§" class="w-full h-12 bg-slate-900/40 border border-white/5 rounded-xl px-4 text-xs font-bold outline-none">
                </div>

                <div class="space-y-1.5">
                    <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                    <input type="text" id="f-note" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ù† Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ..." class="w-full h-12 bg-slate-900/40 border border-white/5 rounded-xl px-4 text-xs font-bold outline-none">
                </div>

                <button type="submit" class="w-full h-16 premium-gradient rounded-2xl text-white font-black text-lg shadow-xl shadow-brand-primary/20 mt-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
            </form>
        </div>
    </div>

    <div id="export-modal" class="modal-backdrop fixed inset-0 bg-slate-950/80 backdrop-blur-xl z-[200] hidden flex items-center justify-center p-6 overflow-y-auto">
        <div class="glass w-full max-w-sm rounded-[2rem] p-8 space-y-6 relative">
            <button onclick="UI.closeModal('export-modal')" class="absolute top-4 left-4 text-slate-500 hover:text-white transition-colors">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            <div class="text-center space-y-2 pt-4">
                <h3 class="text-lg font-black">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØµØ¯ÙŠØ±</h3>
            </div>
            
            <div class="grid grid-cols-1 gap-3">
                <button onclick="Export.toWhatsApp()" class="flex items-center gap-4 p-4 rounded-2xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-500 font-black text-xs tap-scale">
                    <div class="w-10 h-10 rounded-xl bg-emerald-500 flex items-center justify-center text-white"><i class="fa-brands fa-whatsapp text-xl"></i></div>
                    ØªÙ‚Ø±ÙŠØ± ÙˆØ§ØªØ³Ø§Ø¨ (ÙƒÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª)
                </button>
                <button onclick="Export.toPDF()" class="flex items-center gap-4 p-4 rounded-2xl bg-red-500/10 border border-red-500/20 text-red-500 font-black text-xs tap-scale">
                    <div class="w-10 h-10 rounded-xl bg-red-500 flex items-center justify-center text-white"><i class="fa-solid fa-file-pdf text-xl"></i></div>
                    ØªØµØ¯ÙŠØ± PDF Ø´Ø§Ù…Ù„
                </button>
                <button onclick="Export.toExcel()" class="flex items-center gap-4 p-4 rounded-2xl bg-blue-500/10 border border-blue-500/20 text-blue-500 font-black text-xs tap-scale">
                    <div class="w-10 h-10 rounded-xl bg-blue-500 flex items-center justify-center text-white"><i class="fa-solid fa-file-excel text-xl"></i></div>
                    ØªØµØ¯ÙŠØ± Excel ÙƒØ§Ù…Ù„
                </button>
                <div class="grid grid-cols-2 gap-3 mt-2">
                    <button onclick="Export.backupJSON()" class="py-3 rounded-xl glass text-[10px] font-black uppercase text-slate-400">Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                    <label class="py-3 rounded-xl glass text-[10px] font-black uppercase text-slate-400 text-center cursor-pointer">
                        Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
                        <input type="file" id="import-json" class="hidden" onchange="Export.importJSON(event)">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-backdrop fixed inset-0 bg-slate-950/80 backdrop-blur-xl z-[200] hidden flex items-center justify-center p-6">
        <div class="glass w-full max-w-md rounded-[2.5rem] p-10 space-y-8 overflow-y-auto max-h-[90vh] no-scrollbar">
            <div class="flex flex-col items-center">
                <div class="w-24 h-24 rounded-[2rem] premium-gradient flex items-center justify-center shadow-2xl mb-4 relative">
                    <i class="fa-solid fa-user-tie text-white text-4xl"></i>
                </div>
                <h3 class="text-xl font-black">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="s-name" class="w-full h-12 bg-slate-900/40 rounded-xl px-4 text-xs font-bold outline-none border border-white/5">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ø§Ù„Ø´Ø±ÙƒØ©</label>
                        <input type="text" id="s-company" class="w-full h-12 bg-slate-900/40 rounded-xl px-4 text-xs font-bold outline-none border border-white/5">
                    </div>
                </div>
                
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label>
                    <input type="number" id="s-budget-work" class="w-full h-12 bg-slate-900/40 rounded-xl px-4 text-xs font-bold outline-none border border-white/5">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-500 uppercase px-1">Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</label>
                    <input type="number" id="s-budget-pers" class="w-full h-12 bg-slate-900/40 rounded-xl px-4 text-xs font-bold outline-none border border-white/5">
                </div>

                <div class="p-4 rounded-2xl bg-amber-500/5 border border-amber-500/20 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-amber-500">ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ø±Ù‚Ù… Ø³Ø±ÙŠ</span>
                        <input type="checkbox" id="s-wallet-pin-enabled" class="toggle" checked>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase block mb-1">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…Ø­ÙØ¸Ø© (4 Ø£Ø±Ù‚Ø§Ù…)</label>
                        <input type="password" id="s-wallet-pin" maxlength="4" placeholder="Ø£Ø¯Ø®Ù„ 4 Ø£Ø±Ù‚Ø§Ù…" class="w-full h-10 bg-slate-950 rounded-lg px-4 text-xs font-bold outline-none border border-white/5" value="0000">
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="UI.saveSettings()" class="flex-1 h-14 premium-gradient rounded-2xl font-black text-white shadow-lg">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="wallet-auth-modal" class="modal-backdrop fixed inset-0 bg-slate-950/90 backdrop-blur-xl z-[300] hidden flex flex-col items-center justify-center p-6">
        <div class="glass w-full max-w-xs rounded-[2.5rem] p-8 text-center space-y-6">
            <div class="w-16 h-16 rounded-full bg-amber-500/20 mx-auto flex items-center justify-center text-amber-500 text-2xl">
                <i class="fa-solid fa-lock"></i>
            </div>
            <h3 class="text-lg font-black">Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø±ÙŠØ©</h3>
            <p class="text-xs font-bold text-slate-500">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <div class="flex gap-3 justify-center mb-2" id="wallet-pin-dots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="grid grid-cols-3 gap-3 mt-4">
                <button onclick="WalletAuth.push(1)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">1</button>
                <button onclick="WalletAuth.push(2)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">2</button>
                <button onclick="WalletAuth.push(3)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">3</button>
                <button onclick="WalletAuth.push(4)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">4</button>
                <button onclick="WalletAuth.push(5)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">5</button>
                <button onclick="WalletAuth.push(6)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">6</button>
                <button onclick="WalletAuth.push(7)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">7</button>
                <button onclick="WalletAuth.push(8)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">8</button>
                <button onclick="WalletAuth.push(9)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">9</button>
                <button onclick="WalletAuth.clear()" class="w-14 h-14 rounded-full glass flex items-center justify-center text-sm font-bold text-red-500">Ù…Ø³Ø­</button>
                <button onclick="WalletAuth.push(0)" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl font-black">0</button>
                <button onclick="WalletAuth.back()" class="w-14 h-14 rounded-full glass flex items-center justify-center text-xl"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>
    </div>

    <div id="wallet-modal" class="modal-backdrop fixed inset-0 bg-slate-950/80 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-6">
        <div class="glass w-full max-w-sm rounded-[2.5rem] p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-black flex items-center gap-2"><i class="fa-solid fa-wallet text-amber-500"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø©</h3>
                <button onclick="UI.closeModal('wallet-modal')" class="text-slate-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-4 rounded-2xl wallet-card-cash">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-500/30 flex items-center justify-center text-emerald-500 text-lg">
                            <i class="fa-solid fa-money-bill-wave"></i>
                        </div>
                        <span class="text-sm font-black wallet-label">ÙƒØ§Ø´</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="wallet-cash" class="text-sm font-black wallet-balance">0</span>
                        <button onclick="Wallet.modify('cash', 'add')" class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 rounded-2xl wallet-card-visa">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500/30 flex items-center justify-center text-blue-500 text-lg">
                            <i class="fa-brands fa-cc-visa"></i>
                        </div>
                        <span class="text-sm font-black wallet-label">ÙÙŠØ²Ø§</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="wallet-visa" class="text-sm font-black wallet-balance">0</span>
                        <button onclick="Wallet.modify('visa', 'add')" class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 rounded-2xl wallet-card-vodafone">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-amber-500/30 flex items-center justify-center text-amber-600 dark:text-amber-400 text-lg">
                            <i class="fa-solid fa-mobile-screen-button"></i>
                        </div>
                        <span class="text-sm font-black wallet-label">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="wallet-vodafone" class="text-sm font-black wallet-balance">0</span>
                        <button onclick="Wallet.modify('vodafone', 'add')" class="w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>
            </div>
            <button onclick="UI.closeModal('wallet-modal')" class="w-full py-4 text-xs font-black text-slate-600">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 px-6 py-4 rounded-2xl glass shadow-2xl opacity-0 translate-y-[-20px] transition-all z-[999] flex items-center gap-3 pointer-events-none">
        <div id="toast-icon" class="w-8 h-8 rounded-full flex items-center justify-center"></div>
        <p id="toast-msg" class="text-xs font-black"></p>
    </div>

    <script>
        (function() {
            // Storage Helper
            const Storage = {
                prefix: 'ep_elite_',
                save: (key, val) => localStorage.setItem(Storage.prefix + key, JSON.stringify(val)),
                get: (key) => {
                    const data = localStorage.getItem(Storage.prefix + key);
                    try { return data ? JSON.parse(data) : null; } catch(e) { return null; }
                }
            };

            // Main Data Handling
            const Data = {
                entries: Storage.get('entries') || [],
                config: Storage.get('config') || { 
                    name: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 
                    company: '', 
                    budgetWork: 2000, 
                    budgetPers: 5000,
                    isDark: true,
                    hideAmounts: false,
                    walletBalances: { cash: 0, visa: 0, vodafone: 0 },
                    walletPinEnabled: true,
                    walletPin: '0000'
                },

                // Ù…Ø·ÙˆØ±Ø©: ØªØ¯Ø¹Ù… Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„Ø®ØµÙ… Ù…Ù† Ø£ÙŠ Ù…Ø­ÙØ¸Ø©
                deductFromWallet: function(amount, walletType) {
                    walletType = walletType || 'cash';
                    if (Data.config.walletBalances[walletType] >= amount) {
                        Data.config.walletBalances[walletType] -= amount;
                        return true;
                    }
                    return false;
                },

                addEntry: function(entry) {
                    if (!this.deductFromWallet(entry.amount, entry.wallet)) {
                        UI.notify(`âš ï¸ Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© (${entry.wallet}) ØºÙŠØ± ÙƒØ§ÙÙ`, 'error');
                        return false;
                    }
                    Data.entries.unshift({ id: Date.now(), ...entry });
                    Data.save();
                    return true;
                },

                updateEntry: function(id, updated) {
                    const idx = Data.entries.findIndex(e => e.id === id);
                    if(idx !== -1) {
                        const oldEntry = Data.entries[idx];
                        const oldWallet = oldEntry.wallet || 'cash';
                        
                        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
                        Data.config.walletBalances[oldWallet] += oldEntry.amount;

                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                        if (Data.config.walletBalances[updated.wallet] >= updated.amount) {
                            Data.config.walletBalances[updated.wallet] -= updated.amount;
                            Data.entries[idx] = { ...oldEntry, ...updated };
                            Data.save();
                            return true;
                        } else {
                            // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
                            Data.config.walletBalances[oldWallet] -= oldEntry.amount;
                            UI.notify(`âš ï¸ Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸Ø© (${updated.wallet}) ØºÙŠØ± ÙƒØ§ÙÙ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©`, 'error');
                            return false;
                        }
                    }
                    return false;
                },

                deleteEntry: function(id) {
                    const idx = Data.entries.findIndex(e => e.id === id);
                    if(idx !== -1) {
                        const entry = Data.entries[idx];
                        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø®ØµÙ… Ù…Ù†Ù‡Ø§
                        Data.config.walletBalances[entry.wallet || 'cash'] += entry.amount;
                        Data.entries = Data.entries.filter(e => e.id !== id);
                        Data.save();
                        return true;
                    }
                    return false;
                },

                save: () => {
                    Storage.save('entries', Data.entries);
                    Storage.save('config', Data.config);
                    UI.refresh();
                },

                getFiltered: (query = '', type = 'all') => {
                    return Data.entries.filter(e => {
                        const matchesType = type === 'all' || e.section === type;
                        const matchesSearch = e.note.toLowerCase().includes(query.toLowerCase()) || 
                                              e.category.toLowerCase().includes(query.toLowerCase());
                        return matchesType && matchesSearch;
                    });
                }
            };

            // Analytics Module
            const Analytics = {
                getMonthlyStats: (month, year) => {
                    const filtered = Data.entries.filter(e => {
                        const d = new Date(e.date);
                        return d.getMonth() === month && d.getFullYear() === year;
                    });
                    const work = filtered.filter(e => e.section === 'work').reduce((s, e) => s + e.amount, 0);
                    const pers = filtered.filter(e => e.section === 'personal').reduce((s, e) => s + e.amount, 0);
                    return { work, pers, total: work + pers };
                },
                getCategoryDist: () => {
                    const dist = {};
                    Data.entries.forEach(e => dist[e.category] = (dist[e.category] || 0) + e.amount);
                    return dist;
                },
                getForecast: () => {
                    const now = new Date();
                    const daysPassed = now.getDate();
                    const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                    const spent = Analytics.getMonthlyStats(now.getMonth(), now.getFullYear()).total;
                    const dailyAvg = spent / daysPassed;
                    return { dailyAvg, expectedTotal: dailyAvg * totalDays, growth: 0 };
                }
            };

            // Wallet Module
            const Wallet = {
                showWallet: function() {
                    document.getElementById('wallet-cash').innerText = Data.config.walletBalances.cash.toFixed(2);
                    document.getElementById('wallet-visa').innerText = Data.config.walletBalances.visa.toFixed(2);
                    document.getElementById('wallet-vodafone').innerText = Data.config.walletBalances.vodafone.toFixed(2);
                    UI.showModal('wallet-modal');
                },
                modify: function(type, action) {
                    let amount = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ ${type === 'cash' ? 'Ø§Ù„ÙƒØ§Ø´' : (type === 'visa' ? 'Ø§Ù„ÙÙŠØ²Ø§' : 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´')}:`, '0');
                    if (amount === null) return;
                    amount = parseFloat(amount);
                    if (isNaN(amount) || amount <= 0) {
                        UI.notify('Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                        return;
                    }
                    Data.config.walletBalances[type] += amount;
                    UI.notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
                    Data.save();
                    this.showWallet();
                }
            };

            // Wallet Authentication
            const WalletAuth = {
                currentInput: '',
                showAuth: function() {
                    if (!Data.config.walletPinEnabled) {
                        Wallet.showWallet();
                        return;
                    }
                    this.clear();
                    UI.showModal('wallet-auth-modal');
                },
                push: function(num) {
                    if (this.currentInput.length < 4) {
                        this.currentInput += num;
                        this.updateDots();
                        if (this.currentInput.length === 4) setTimeout(() => this.verify(), 100);
                    }
                },
                back: function() {
                    this.currentInput = this.currentInput.slice(0, -1);
                    this.updateDots();
                },
                clear: function() {
                    this.currentInput = '';
                    this.updateDots();
                },
                updateDots: function() {
                    const dots = document.querySelectorAll('#wallet-pin-dots .pin-dot');
                    dots.forEach((d, i) => {
                        if (i < this.currentInput.length) d.classList.add('active');
                        else d.classList.remove('active');
                    });
                },
                verify: function() {
                    if (this.currentInput === Data.config.walletPin) {
                        UI.closeModal('wallet-auth-modal');
                        Wallet.showWallet();
                    } else {
                        UI.notify('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                        this.clear();
                    }
                }
            };

            // UI Module
            const UI = {
                state: { activeFormSection: 'work', currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear() },
                
                init: function() {
                    UI.applyTheme();
                    UI.setFormSection('work');
                    UI.refresh();
                    
                    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                    window.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal-backdrop')) {
                            e.target.classList.add('hidden');
                            if(e.target.id === 'add-modal') document.getElementById('entry-id').value = '';
                        }
                    });

                    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    document.getElementById('s-name').value = Data.config.name;
                    document.getElementById('s-company').value = Data.config.company;
                    document.getElementById('s-budget-work').value = Data.config.budgetWork;
                    document.getElementById('s-budget-pers').value = Data.config.budgetPers;
                    document.getElementById('s-wallet-pin-enabled').checked = Data.config.walletPinEnabled;
                    document.getElementById('s-wallet-pin').value = Data.config.walletPin;

                    document.getElementById('main-form').onsubmit = (e) => {
                        e.preventDefault();
                        let category = document.getElementById('f-category').value;
                        if (category === 'Ø£Ø®Ø±Ù‰') {
                            const customCat = document.getElementById('f-custom-category').value.trim();
                            if (customCat === '') return UI.notify('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'error');
                            category = customCat;
                        }

                        const entry = {
                            amount: parseFloat(document.getElementById('f-amount').value),
                            category: category,
                            wallet: document.getElementById('f-wallet').value,
                            date: document.getElementById('f-date').value,
                            note: document.getElementById('f-note').value,
                            section: UI.state.activeFormSection
                        };
                        
                        const id = document.getElementById('entry-id').value;
                        let success = id ? Data.updateEntry(Number(id), entry) : Data.addEntry(entry);
                        
                        if (success) {
                            UI.closeModal('add-modal');
                            UI.notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
                        }
                    };

                    document.getElementById('f-category').addEventListener('change', (e) => {
                        const customContainer = document.getElementById('custom-category-container');
                        e.target.value === 'Ø£Ø®Ø±Ù‰' ? customContainer.classList.remove('hidden') : customContainer.classList.add('hidden');
                    });
                },

                refresh: function() {
                    UI.refreshDashboard();
                    UI.refreshList();
                    UI.renderCharts();
                    UI.refreshInsights();
                },

                refreshDashboard: function() {
                    const stats = Analytics.getMonthlyStats(UI.state.currentMonth, UI.state.currentYear);
                    const show = !Data.config.hideAmounts;
                    document.getElementById('personal-budget-label').innerText = show ? stats.pers.toFixed(2) : 'â€¢â€¢â€¢â€¢';
                    const pPerc = Math.min((stats.pers / Data.config.budgetPers) * 100, 100) || 0;
                    document.getElementById('personal-budget-percent').innerText = `${pPerc.toFixed(0)}%`;
                    document.getElementById('personal-budget-progress').style.width = `${pPerc}%`;
                    if(pPerc >= 90) document.getElementById('personal-budget-progress').className = "h-full bg-red-500";
                    else if(pPerc >= 75) document.getElementById('personal-budget-progress').className = "h-full bg-amber-500";
                    else document.getElementById('personal-budget-progress').className = "h-full premium-gradient";
                },

                getWalletBadge: function(walletType) {
                    const types = {
                        cash: '<span class="bg-emerald-500/10 text-emerald-500 px-2 py-0.5 rounded text-[8px] ml-1">ÙƒØ§Ø´</span>',
                        visa: '<span class="bg-blue-500/10 text-blue-500 px-2 py-0.5 rounded text-[8px] ml-1">ÙÙŠØ²Ø§</span>',
                        vodafone: '<span class="bg-amber-500/10 text-amber-500 px-2 py-0.5 rounded text-[8px] ml-1">Vf Cash</span>'
                    };
                    return types[walletType] || types.cash;
                },

                refreshList: function() {
                    const query = document.getElementById('search-input').value;
                    const type = document.getElementById('filter-type').value;
                    const list = Data.getFiltered(query, type);
                    const container = document.getElementById('entries-list');
                    container.innerHTML = '';
                    
                    if(!list.length) {
                        container.innerHTML = '<div class="py-20 text-center text-slate-600 font-bold text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
                        return;
                    }

                    const fragment = document.createDocumentFragment();
                    list.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "swipe-container";
                        div.innerHTML = `
                            <div class="glass p-5 rounded-3xl flex justify-between items-center relative z-10 bg-[#1e293b]/20 dark:bg-white/5">
                                <div class="flex items-center gap-4">
                                    <div class="w-11 h-11 rounded-xl ${item.section === 'work' ? 'bg-brand-primary/10 text-brand-primary' : 'bg-brand-secondary/10 text-brand-secondary'} flex items-center justify-center text-lg">
                                        <i class="fa-solid ${UI.getIcon(item.category)}"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-sm font-black">${item.note || item.category}</h5>
                                        <p class="text-[9px] font-bold text-slate-500 uppercase flex items-center mt-1">
                                            ${item.date} ${UI.getWalletBadge(item.wallet)}
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <p class="text-sm font-black dark:text-white light:text-slate-900">${Data.config.hideAmounts ? 'â€¢â€¢â€¢' : item.amount.toFixed(2)}</p>
                                        <span class="text-[8px] font-bold text-slate-500 uppercase">${item.section === 'work' ? 'Ø¹Ù…Ù„' : 'Ø´Ø®ØµÙŠ'}</span>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <button onclick="UI.editEntry(${item.id})" class="text-slate-500 hover:text-brand-primary text-xs"><i class="fa-solid fa-pen"></i></button>
                                        <button onclick="UI.deleteEntry(${item.id})" class="text-slate-500 hover:text-red-500 text-xs"><i class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        `;
                        fragment.appendChild(div);
                    });
                    container.appendChild(fragment);
                },

                refreshInsights: function() {
                    const forecast = Analytics.getForecast();
                    const dist = Analytics.getCategoryDist();
                    const topCat = Object.entries(dist).sort((a,b) => b[1] - a[1])[0]?.[0] || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
                    document.getElementById('insight-forecast').innerHTML = `Ù…ØªÙˆÙ‚Ø¹ Ø¥Ù†ÙØ§Ù‚ <span class="text-brand-primary">${forecast.expectedTotal.toFixed(0)} Ø¬.Ù…</span> Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±`;
                    document.getElementById('insight-category').innerHTML = `Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù†ÙØ§Ù‚Ø§Ù‹: <span class="text-brand-accent">${topCat}</span>`;
                },

                renderCharts: function() {
                    const ctxPie = document.getElementById('pieChart').getContext('2d');
                    const ctxLine = document.getElementById('lineChart').getContext('2d');
                    const dist = Analytics.getCategoryDist();
                    if(window.pie) window.pie.destroy();
                    window.pie = new Chart(ctxPie, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(dist),
                            datasets: [{
                                data: Object.values(dist),
                                backgroundColor: ['#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#10b981', '#ec4899', '#14b8a6', '#f97316'],
                                borderWidth: 0
                            }]
                        },
                        options: { plugins: { legend: { display: false } }, cutout: '75%' }
                    });
                    if(window.line) window.line.destroy();
                    const last7Days = [...Array(7)].map((_, i) => {
                        const d = new Date(); d.setDate(d.getDate() - i); return d.toISOString().split('T')[0];
                    }).reverse();
                    const dailyData = last7Days.map(date => Data.entries.filter(e => e.date === date).reduce((s, e) => s + e.amount, 0));
                    window.line = new Chart(ctxLine, {
                        type: 'line',
                        data: {
                            labels: last7Days.map(d => d.split('-')[2]),
                            datasets: [{
                                label: 'Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ',
                                data: dailyData,
                                borderColor: '#3b82f6',
                                tension: 0.4,
                                fill: true,
                                backgroundColor: 'rgba(59, 130, 246, 0.1)'
                            }]
                        },
                        options: { scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 9 } } } }, plugins: { legend: { display: false } } }
                    });
                },

                getIcon: (cat) => {
                    const map = { 
                        'Ù…ÙŠÙ†ÙŠ Ø¨Ø§Øµ': 'fa-bus', 'Ø¨Ø§Øµ': 'fa-bus', 'Ø§ÙˆØ¨Ø±': 'fa-taxi', 'Ù…ØªØ±Ùˆ': 'fa-train-subway-tunnel',
                        'Ø¨Ù†Ø²ÙŠÙ†': 'fa-gas-pump', 'ØµÙŠØ§Ù†Ø©': 'fa-screwdriver-wrench', 'Ø§ÙƒÙ„': 'fa-utensils',
                        'ÙƒØ§ÙÙŠÙ‡': 'fa-mug-hot', 'Ø®Ø±ÙˆØ¬': 'fa-door-open', 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª': 'fa-cart-shopping',
                        'ØªØ±ÙÙŠÙ‡': 'fa-gamepad', 'ØµØ­Ø©': 'fa-heart-pulse', 'Ø¥ÙŠØ¬Ø§Ø±': 'fa-house-circle-check',
                        'Ø£Ø®Ø±Ù‰': 'fa-receipt', 'Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª': 'fa-taxi'
                    };
                    return map[cat] || 'fa-receipt';
                },

                setFormSection: function(section) {
                    UI.state.activeFormSection = section;
                    const cats = section === 'work' ? 
                        ['Ù…ÙŠÙ†ÙŠ Ø¨Ø§Øµ', 'Ø¨Ø§Øµ', 'Ø§ÙˆØ¨Ø±', 'Ù…ØªØ±Ùˆ', 'Ø¨Ù†Ø²ÙŠÙ†', 'ØµÙŠØ§Ù†Ø©', 'Ø£Ø®Ø±Ù‰'] : 
                        ['Ø§ÙƒÙ„', 'Ø³Ø¬Ø§ÙŠØ±', 'Ù…ÙˆØ§ØµÙ„Ø§Øª', 'ÙƒØ§ÙÙŠÙ‡', 'Ø®Ø±ÙˆØ¬', 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', 'ØªØ±ÙÙŠÙ‡', 'ØµØ­Ø©', 'Ø¥ÙŠØ¬Ø§Ø±', 'Ø£Ø®Ø±Ù‰'];
                    
                    document.getElementById('f-category').innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
                    
                    const activeClass = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-brand-primary text-white";
                    const inactiveClass = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase text-slate-500";
                    document.getElementById('form-tab-work').className = section === 'work' ? activeClass : inactiveClass;
                    document.getElementById('form-tab-personal').className = section === 'personal' ? activeClass : inactiveClass;
                    document.getElementById('custom-category-container').classList.add('hidden');
                },

                editEntry: function(id) {
                    const entry = Data.entries.find(e => e.id === id);
                    if(!entry) return;
                    document.getElementById('entry-id').value = id;
                    document.getElementById('f-amount').value = entry.amount;
                    UI.setFormSection(entry.section);
                    
                    const select = document.getElementById('f-category');
                    if (Array.from(select.options).some(opt => opt.value === entry.category)) {
                        select.value = entry.category;
                        document.getElementById('custom-category-container').classList.add('hidden');
                    } else {
                        select.value = 'Ø£Ø®Ø±Ù‰';
                        document.getElementById('f-custom-category').value = entry.category;
                        document.getElementById('custom-category-container').classList.remove('hidden');
                    }
                    
                    document.getElementById('f-wallet').value = entry.wallet || 'cash';
                    document.getElementById('f-date').value = entry.date;
                    document.getElementById('f-note').value = entry.note;
                    document.getElementById('modal-title').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©";
                    UI.showModal('add-modal');
                },

                deleteEntry: function(id) {
                    if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                        if (Data.deleteEntry(id)) UI.notify('ØªÙ… Ø§Ù„Ø­Ø°Ù ÙˆØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø­ÙØ¸Ø©', 'success');
                    }
                },

                showModal: function(id) {
                    if(id === 'add-modal' && !document.getElementById('entry-id').value) {
                        document.getElementById('modal-title').innerText = "Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©";
                        document.getElementById('main-form').reset();
                        document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
                        document.getElementById('custom-category-container').classList.add('hidden');
                    }
                    document.getElementById(id).classList.remove('hidden');
                },
                
                closeModal: function(id) { 
                    document.getElementById(id).classList.add('hidden');
                    if(id === 'add-modal') document.getElementById('entry-id').value = '';
                },

                toggleTheme: function() {
                    Data.config.isDark = !Data.config.isDark;
                    UI.applyTheme();
                    Data.save();
                },

                applyTheme: function() {
                    document.body.className = Data.config.isDark ? 'dark font-sans overflow-x-hidden' : 'light font-sans overflow-x-hidden';
                    document.getElementById('theme-icon').className = Data.config.isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                },

                toggleAmountVisibility: function() {
                    Data.config.hideAmounts = !Data.config.hideAmounts;
                    document.getElementById('eye-icon').className = Data.config.hideAmounts ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye';
                    Data.save();
                },

                saveSettings: function() {
                    Data.config.name = document.getElementById('s-name').value;
                    Data.config.company = document.getElementById('s-company').value;
                    Data.config.budgetWork = parseFloat(document.getElementById('s-budget-work').value) || 0;
                    Data.config.budgetPers = parseFloat(document.getElementById('s-budget-pers').value) || 0;
                    Data.config.walletPinEnabled = document.getElementById('s-wallet-pin-enabled').checked;
                    
                    const newPin = document.getElementById('s-wallet-pin').value;
                    if (newPin && /^\d{4}$/.test(newPin)) Data.config.walletPin = newPin;
                    else return UI.notify('Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…Ø­ÙØ¸Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù…', 'error');

                    Data.save();
                    UI.closeModal('settings-modal');
                    UI.notify('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                },

                notify: function(msg, type = 'success') {
                    const toast = document.getElementById('toast');
                    const icon = document.getElementById('toast-icon');
                    document.getElementById('toast-msg').innerText = msg;
                    icon.className = `w-8 h-8 rounded-full flex items-center justify-center ${type === 'success' ? 'bg-emerald-500/20 text-emerald-500' : 'bg-red-500/20 text-red-500'}`;
                    icon.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check' : 'fa-triangle-exclamation'} text-xs"></i>`;
                    toast.classList.replace('opacity-0', 'opacity-100');
                    toast.classList.replace('translate-y-[-20px]', 'translate-y-0');
                    setTimeout(() => {
                        toast.classList.replace('opacity-100', 'opacity-0');
                        toast.classList.replace('translate-y-0', 'translate-y-[-20px]');
                    }, 3000);
                }
            };

            // Export Module
            const Export = {
                toWhatsApp: function() {
                    if(Data.entries.length === 0) return UI.notify(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª`, 'error');
                    let text = `ğŸ“Š *ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª*\nğŸ‘¤ *Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:* ${Data.config.name}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                    Data.entries.forEach(e => text += `â€¢ ${e.note || e.category}: *${e.amount} Ø¬.Ù…*\n`);
                    text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${Data.entries.reduce((s,i)=>s+i.amount,0)} Ø¬.Ù…*`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
                },
                toPDF: function() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFont("helvetica", "bold");
                    doc.text(`Financial Report`, 10, 10);
                    doc.setFontSize(10);
                    let y = 30;
                    doc.text("Date", 10, y); doc.text("Category", 50, y); doc.text("Amount", 170, y);
                    Data.entries.slice(0, 30).forEach(e => {
                        y += 10;
                        doc.text(e.date, 10, y); doc.text(e.category, 50, y); doc.text(e.amount.toString(), 170, y);
                    });
                    doc.save(`Report.pdf`);
                },
                toExcel: function() {
                    const ws = XLSX.utils.json_to_sheet(Data.entries);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Data");
                    XLSX.writeFile(wb, `ExpenseData.xlsx`);
                },
                backupJSON: function() {
                    const blob = new Blob([JSON.stringify(Data.entries)], {type: "application/json"});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob); a.download = `backup_${Date.now()}.json`; a.click();
                },
                importJSON: function(event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if(Array.isArray(imported)) {
                                Data.entries = [...imported, ...Data.entries];
                                Data.save();
                                UI.notify('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                                UI.closeModal('export-modal');
                            }
                        } catch(err) { UI.notify('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù', 'error'); }
                    };
                    reader.readAsText(file);
                }
            };

            window.UI = UI; window.Export = Export; window.Wallet = Wallet; window.WalletAuth = WalletAuth;
            window.onload = UI.init;
        })();
    </script>
</body>
</html>
